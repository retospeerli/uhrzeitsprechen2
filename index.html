<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uhrzeit ‚Äì Sprechen (Alltagssprache)</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .app {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 2rem;
      max-width: 1200px;
      width: 100%;
      aspect-ratio: 16/9;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    /* Header Bereich */
    .app-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f3f4f6;
    }
    h1 {
      margin: 0 0 0.5rem;
      font-size: 2.2rem;
      color: #111827;
      font-weight: 800;
    }
    .subtitle {
      color: #6b7280;
      margin: 0;
      font-size: 1.1rem;
      line-height: 1.4;
    }
    
    /* Hauptinhalt mit Grid */
    .app-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.5rem;
      flex: 1;
      align-items: center;
    }
    
    /* Linke Seite - Uhr und Steuerung */
    .clock-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }
    .clock-wrapper {
      position: relative;
    }
    #clock-canvas {
      background: #f9fafb;
      border-radius: 50%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), inset 0 0 20px rgba(0, 0, 0, 0.05);
      border: 8px solid #ffffff;
    }
    .clock-label {
      position: absolute;
      bottom: -20px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 1rem;
      color: #4b5563;
      font-weight: 600;
    }
    
    /* Rechte Seite - Interaktion */
    .interaction-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    /* Antwort-Bereich */
    .answer-box {
      background: #f9fafb;
      border-radius: 20px;
      padding: 1.5rem;
      border: 2px solid #e5e7eb;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
    }
    .equation {
      text-align: center;
      margin: 0 0 1rem;
      font-size: 1.3rem;
      color: #111827;
      font-weight: 800;
    }
    
    /* Mikrofon und Buttons */
    .mic-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .mic-btn {
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }
    .mic-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    .mic-btn.listening {
      background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
      animation: pulse 1.5s infinite;
    }
    .mic-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    .check-btn {
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      border-radius: 16px;
      border: 2px solid #2563eb;
      background: white;
      color: #2563eb;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .check-btn:hover {
      background: #2563eb;
      color: white;
      transform: translateY(-2px);
    }
    
    /* Erkannte Sprache */
    .heard {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 1.2rem;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin-top: 1rem;
    }
    .heard-label {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .heard-text {
      font-size: 1.3rem;
      color: #111827;
      font-weight: 800;
      word-break: break-word;
      min-height: 1.5em;
    }
    
    /* Feedback */
    .feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 16px;
      font-weight: 800;
      text-align: center;
      font-size: 1.2rem;
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .feedback.ok {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    .feedback.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    
    /* Start-Bildschirm */
    #start-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      text-align: center;
    }
    .choice-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin: 1.5rem 0;
      width: 80%;
    }
    .choice-btn {
      padding: 1.2rem 1rem;
      border-radius: 16px;
      border: 3px solid #e5e7eb;
      background: #f9fafb;
      font-size: 1.1rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .choice-btn:hover {
      border-color: #2563eb;
      transform: translateY(-2px);
    }
    .choice-btn.selected {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border-color: #1d4ed8;
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    }
    .selected-info {
      font-size: 1rem;
      color: #4b5563;
      margin: 1rem 0;
      min-height: 1.5rem;
      font-weight: 600;
    }
    .start-btn {
      margin-top: 1.5rem;
      padding: 1.2rem 3rem;
      font-size: 1.3rem;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-weight: 800;
      transition: all 0.3s ease;
      width: 80%;
    }
    .start-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
    }
    .start-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    /* Quiz-Screen */
    #quiz-screen {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .progress {
      font-size: 1.1rem;
      color: #4b5563;
      font-weight: 600;
    }
    .tag {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 20px;
      font-size: 1rem;
      font-weight: 800;
    }
    
    /* Statistik */
    .stats {
      background: #f9fafb;
      border-radius: 16px;
      padding: 1rem 1.5rem;
      margin-top: auto;
      border: 2px solid #e5e7eb;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      text-align: center;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #6b7280;
      font-weight: 600;
    }
    .stat-value {
      font-size: 1.5rem;
      color: #111827;
      font-weight: 800;
    }
    
    /* Ergebnis-Screen */
    #result-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      text-align: center;
    }
    .result-title {
      font-size: 2.5rem;
      color: #111827;
      margin-bottom: 1.5rem;
      font-weight: 800;
    }
    .result-summary {
      background: #f9fafb;
      border-radius: 20px;
      padding: 2rem;
      margin: 1.5rem 0;
      border: 2px solid #e5e7eb;
      max-width: 80%;
    }
    .result-stats {
      font-size: 1.3rem;
      color: #374151;
      line-height: 1.6;
    }
    .result-actions {
      display: flex;
      gap: 1.5rem;
      margin-top: 2rem;
    }
    .finish-btn, .restart-btn {
      padding: 1rem 2.5rem;
      font-size: 1.2rem;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      transition: all 0.3s ease;
    }
    .finish-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .finish-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    .restart-btn {
      background: white;
      color: #4b5563;
      border: 2px solid #d1d5db;
    }
    .restart-btn:hover {
      background: #f3f4f6;
      transform: translateY(-2px);
    }
    
    /* Hilfetext */
    .hint {
      font-size: 0.9rem;
      color: #9ca3af;
      text-align: center;
      margin-top: 0.5rem;
      line-height: 1.4;
    }
    
    /* Animationen */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Responsive Anpassungen */
    @media (max-width: 1024px) {
      .app {
        max-width: 95%;
        padding: 1.5rem;
      }
      h1 {
        font-size: 1.8rem;
      }
      .app-content {
        gap: 1.5rem;
      }
    }
    
    @media (max-width: 768px) {
      .app-content {
        grid-template-columns: 1fr;
      }
      .clock-section {
        order: 2;
      }
      .interaction-section {
        order: 1;
      }
      .stats {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- START SCREEN -->
  <div id="start-screen">
    <h1>Uhrzeit √ºben üá©üá™</h1>
    <p class="subtitle">Lies die analoge Uhr und <strong>sage die Uhrzeit</strong> in Umgangssprache</p>
    
    <div style="margin-top: 2rem;">
      <div style="margin-bottom: 1rem; font-size: 1.2rem; color: #4b5563; font-weight: 600;">Klasse w√§hlen</div>
      <div class="choice-grid" id="grade-grid">
        <button type="button" class="choice-btn grade-btn" data-grade="2">2. Klasse</button>
        <button type="button" class="choice-btn grade-btn" data-grade="3">3. Klasse</button>
      </div>
    </div>
    
    <div style="margin-top: 2rem;">
      <div style="margin-bottom: 1rem; font-size: 1.2rem; color: #4b5563; font-weight: 600;">Schwierigkeit</div>
      <div class="choice-grid" id="difficulty-grid">
        <button type="button" class="choice-btn difficulty-btn" data-diff="easy">Einfach</button>
        <button type="button" class="choice-btn difficulty-btn" data-diff="hard">Schwierig</button>
      </div>
    </div>
    
    <div class="selected-info" id="selected-info"></div>
    <button class="start-btn" id="start-btn" disabled>Start Training</button>
    <div class="hint" id="sr-note">Mikrofon erlauben f√ºr Spracherkennung (Chrome/Edge empfohlen)</div>
  </div>

  <!-- QUIZ SCREEN -->
  <div id="quiz-screen" class="hidden">
    <div class="quiz-header">
      <div class="progress" id="progress-text">Aufgabe 1 von 20</div>
      <span class="tag" id="variant-label">Mix: f√ºnf nach</span>
    </div>
    
    <div class="app-content">
      <!-- Linke Seite: Uhr -->
      <div class="clock-section">
        <div class="clock-wrapper">
          <canvas id="clock-canvas" width="300" height="300"></canvas>
          <div class="clock-label">Sage die Uhrzeit in Deutsch</div>
        </div>
      </div>
      
      <!-- Rechte Seite: Interaktion -->
      <div class="interaction-section">
        <div class="answer-box">
          <div class="equation" id="equation-text">Sage die passende Uhrzeit:</div>
          
          <div class="mic-row">
            <button class="mic-btn" id="mic-btn">
              <span>üé§</span> Sprechen
            </button>
            <button class="check-btn" id="check-btn">√úberpr√ºfen</button>
          </div>
          
          <div class="heard">
            <div class="heard-label">Erkannte Sprache:</div>
            <div class="heard-text" id="heard-ui">‚Äî</div>
          </div>
          
          <div class="feedback" id="feedback"></div>
        </div>
      </div>
    </div>
    
    <div class="stats">
      <div class="stat-item">
        <div class="stat-label">Richtig</div>
        <div class="stat-value" id="stat-correct">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Falsch</div>
        <div class="stat-value" id="stat-wrong">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Verbleibend</div>
        <div class="stat-value" id="stat-remaining">20</div>
      </div>
    </div>
  </div>

  <!-- RESULT SCREEN -->
  <div id="result-screen" class="hidden">
    <h2 class="result-title">Geschafft! üéâ</h2>
    
    <div class="result-summary">
      <div class="result-stats" id="result-summary">
        Du hast <strong>20 Uhrzeiten</strong> gel√∂st.<br>
        Richtig: <strong>0</strong> (0%)<br>
        Falsch: <strong>0</strong>
      </div>
    </div>
    
    <p style="color: #6b7280; max-width: 80%; line-height: 1.6; margin: 1rem 0;">
      Klicke auf <strong>‚ÄûFertig"</strong> um den Auftrag abzuschlie√üen,<br>
      oder <strong>‚ÄûWeiter √ºben"</strong> f√ºr mehr Training.
    </p>
    
    <div class="result-actions">
      <button class="finish-btn" id="finish-btn">Fertig</button>
      <button class="restart-btn" id="restart-btn">Weiter √ºben</button>
    </div>
  </div>
</div>

<script>
/* ==========================
   SETTINGS
========================== */
const TOTAL_QUESTIONS = 20;
const GRADE_LABELS = {2:"2. Klasse",3:"3. Klasse"};
const DIFF_LABELS  = {easy:"Einfach",hard:"Schwierig"};

const HOURS = ["eins","zwei","drei","vier","f√ºnf","sechs","sieben","acht","neun","zehn","elf","zw√∂lf"];
const PREFIXES = [
  "punkt",
  "f√ºnf nach","zehn nach","viertel nach","zwanzig nach",
  "f√ºnf vor halb","halb","f√ºnf nach halb",
  "zwanzig vor","viertel vor","zehn vor","f√ºnf vor"
];

// Minuten-Zyklus f√ºr Abwechslung
const MINUTE_CYCLE = [
  { minute: 5,  label: "f√ºnf nach" },
  { minute: 20, label: "zwanzig nach" },
  { minute: 45, label: "viertel vor" },
  { minute: 25, label: "f√ºnf vor halb" },
  { minute: 35, label: "f√ºnf nach halb" },
  { minute: 15, label: "viertel nach" }
];

/* ==========================
   STATE
========================== */
let selectedGrade = null;
let selectedDifficulty = null;
let questionsDone = 0;
let correctAnswers = 0;
let wrongAnswers = 0;
let usedKeys = new Set();
let currentQuestion = null;
let lastRaw = "";
let lastSpoken = "‚Äî";
let lastMinuteUsed = null;

/* ==========================
   DOM ELEMENTS
========================== */
const startScreen = document.getElementById("start-screen");
const quizScreen = document.getElementById("quiz-screen");
const resultScreen = document.getElementById("result-screen");

const gradeGrid = document.getElementById("grade-grid");
const difficultyGrid = document.getElementById("difficulty-grid");
const selectedInfo = document.getElementById("selected-info");
const startBtn = document.getElementById("start-btn");
const srNote = document.getElementById("sr-note");

const progressText = document.getElementById("progress-text");
const variantLabel = document.getElementById("variant-label");
const equationText = document.getElementById("equation-text");
const heardUI = document.getElementById("heard-ui");
const feedback = document.getElementById("feedback");

const statCorrect = document.getElementById("stat-correct");
const statWrong = document.getElementById("stat-wrong");
const statRemaining = document.getElementById("stat-remaining");

const restartBtn = document.getElementById("restart-btn");
const finishBtn = document.getElementById("finish-btn");
const resultSummary = document.getElementById("result-summary");

const micBtn = document.getElementById("mic-btn");
const checkBtn = document.getElementById("check-btn");

const clockCanvas = document.getElementById("clock-canvas");
const clockCtx = clockCanvas.getContext("2d");

/* ==========================
   HELPER FUNCTIONS
========================== */
function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function clamp12(h) {
  return ((h - 1) % 12) + 1;
}

function hourToWord(h) {
  return HOURS[(clamp12(h) - 1)];
}

function normalizeForCompare(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/[^\p{L}\p{N}\s]/gu, " ")
    .replace(/\s+/g, " ")
    .trim();
}

/* ==========================
   TIME TO COLLOQUIAL
========================== */
function timeToColloquial(hour, minute) {
  const h = clamp12(hour);
  const next = (h % 12) + 1;
  const hw = hourToWord(h);
  const nhw = hourToWord(next);
  
  switch(minute) {
    case 0:  return `punkt ${hw}`;
    case 5:  return `f√ºnf nach ${hw}`;
    case 10: return `zehn nach ${hw}`;
    case 15: return `viertel nach ${hw}`;
    case 20: return `zwanzig nach ${hw}`;
    case 25: return `f√ºnf vor halb ${nhw}`;
    case 30: return `halb ${nhw}`;
    case 35: return `f√ºnf nach halb ${nhw}`;
    case 40: return `zwanzig vor ${nhw}`;
    case 45: return `viertel vor ${nhw}`;
    case 50: return `zehn vor ${nhw}`;
    case 55: return `f√ºnf vor ${nhw}`;
    default: return `punkt ${hw}`;
  }
}

/* ==========================
   PHRASE EXTRACTION
========================== */
function extractFirstAllowedPhrase(raw) {
  const clean = normalizeForCompare(raw);
  const prefixesSorted = [...PREFIXES].sort((a, b) => b.length - a.length);

  for(const p of prefixesSorted) {
    for(const h of HOURS) {
      const phrase = normalizeForCompare(`${p} ${h}`);
      if(clean.includes(phrase)) {
        return `${p} ${h}`;
      }
    }
  }
  return "‚Äî";
}

/* ==========================
   QUESTION GENERATION
========================== */
function generateQuestion(index) {
  let minute = MINUTE_CYCLE[index % MINUTE_CYCLE.length].minute;

  if(lastMinuteUsed !== null && minute === lastMinuteUsed) {
    minute = MINUTE_CYCLE[(index + 1) % MINUTE_CYCLE.length].minute;
  }
  lastMinuteUsed = minute;

  let hour, tries = 0;
  while(true) {
    hour = randomInt(1, 12);
    const key = `${hour}:${minute}`;
    if(!usedKeys.has(key)) {
      usedKeys.add(key);
      break;
    }
    if(++tries > 300) break;
  }

  const expected = timeToColloquial(hour, minute);
  const label = MINUTE_CYCLE[index % MINUTE_CYCLE.length].label;
  return { hour, minute, expected, label };
}

/* ==========================
   CLOCK DRAWING
========================== */
function drawClock(hour, minute) {
  const ctx = clockCtx;
  const w = clockCanvas.width;
  const h = clockCanvas.height;
  const r = Math.min(w, h) / 2 - 15;
  const cx = w / 2;
  const cy = h / 2;

  ctx.clearRect(0, 0, w, h);
  ctx.save();
  ctx.translate(cx, cy);

  // Uhrzifferblatt
  ctx.beginPath();
  ctx.arc(0, 0, r, 0, Math.PI * 2);
  ctx.fillStyle = "#ffffff";
  ctx.fill();
  ctx.lineWidth = 4;
  ctx.strokeStyle = "#111827";
  ctx.stroke();

  // Striche f√ºr Stunden und Minuten
  for(let i = 0; i < 60; i++) {
    const a = (Math.PI / 30) * i - Math.PI / 2;
    const isHour = (i % 5 === 0);
    const outer = r - 8;
    const inner = r - (isHour ? 25 : 15);
    
    ctx.beginPath();
    ctx.moveTo(inner * Math.cos(a), inner * Math.sin(a));
    ctx.lineTo(outer * Math.cos(a), outer * Math.sin(a));
    ctx.lineWidth = isHour ? 3 : 1.5;
    ctx.strokeStyle = "#111827";
    ctx.stroke();
  }

  // Minutenzeiger (blau)
  const ma = (Math.PI / 30) * minute - Math.PI / 2;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo((r - 30) * Math.cos(ma), (r - 30) * Math.sin(ma));
  ctx.lineWidth = 5;
  ctx.strokeStyle = "#2563eb";
  ctx.lineCap = "round";
  ctx.stroke();

  // Stundenzeiger (rot)
  const ha = (Math.PI / 6) * ((hour % 12) + minute / 60) - Math.PI / 2;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo((r - 70) * Math.cos(ha), (r - 70) * Math.sin(ha));
  ctx.lineWidth = 6;
  ctx.strokeStyle = "#dc2626";
  ctx.lineCap = "round";
  ctx.stroke();

  // Mittelpunkt
  ctx.beginPath();
  ctx.arc(0, 0, 6, 0, Math.PI * 2);
  ctx.fillStyle = "#111827";
  ctx.fill();

  ctx.restore();
}

/* ==========================
   UI CONTROLS
========================== */
function updateStartControls() {
  if(!selectedGrade) {
    selectedInfo.textContent = "Bitte eine Klasse ausw√§hlen";
    startBtn.disabled = true;
    return;
  }
  if(!selectedDifficulty) {
    selectedInfo.textContent = "Bitte eine Schwierigkeit ausw√§hlen";
    startBtn.disabled = true;
    return;
  }
  selectedInfo.textContent = `Ausgew√§hlt: ${GRADE_LABELS[selectedGrade]}, ${DIFF_LABELS[selectedDifficulty]}`;
  startBtn.disabled = false;
}

// Klasse Auswahl
gradeGrid.querySelectorAll(".grade-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const g = Number(btn.dataset.grade);
    selectedGrade = (selectedGrade === g) ? null : g;
    gradeGrid.querySelectorAll(".grade-btn").forEach(b => 
      b.classList.toggle("selected", Number(b.dataset.grade) === selectedGrade)
    );
    updateStartControls();
  });
});

// Schwierigkeit Auswahl
difficultyGrid.querySelectorAll(".difficulty-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const d = btn.dataset.diff;
    selectedDifficulty = (selectedDifficulty === d) ? null : d;
    difficultyGrid.querySelectorAll(".difficulty-btn").forEach(b => 
      b.classList.toggle("selected", b.dataset.diff === selectedDifficulty)
    );
    updateStartControls();
  });
});

// Start Training
startBtn.addEventListener("click", startTraining);

// Restart Button
restartBtn.addEventListener("click", () => {
  quizScreen.classList.add("hidden");
  resultScreen.classList.add("hidden");
  startScreen.classList.remove("hidden");
});

// Finish Button
finishBtn.addEventListener("click", () => {
  finishBtn.disabled = true;
  finishBtn.textContent = "Erledigt ‚úî";
  try {
    if(window.parent && window.parent !== window) {
      window.parent.postMessage("AppSolved", "*");
    }
  } catch(_) {}
});

/* ==========================
   QUIZ FLOW
========================== */
function startTraining() {
  questionsDone = 0;
  correctAnswers = 0;
  wrongAnswers = 0;
  usedKeys = new Set();
  lastMinuteUsed = null;

  statCorrect.textContent = "0";
  statWrong.textContent = "0";
  statRemaining.textContent = "20";

  lastRaw = "";
  lastSpoken = "‚Äî";
  heardUI.textContent = "‚Äî";
  feedback.textContent = "";
  feedback.className = "feedback";

  startScreen.classList.add("hidden");
  resultScreen.classList.add("hidden");
  quizScreen.classList.remove("hidden");

  newQuestion();
}

function newQuestion() {
  feedback.textContent = "";
  feedback.className = "feedback";
  lastRaw = "";
  lastSpoken = "‚Äî";
  heardUI.textContent = "‚Äî";

  currentQuestion = generateQuestion(questionsDone);
  variantLabel.textContent = `Mix: ${currentQuestion.label}`;
  equationText.textContent = `Sage die Uhrzeit f√ºr ${currentQuestion.hour}:${String(currentQuestion.minute).padStart(2, '0')}`;
  drawClock(currentQuestion.hour, currentQuestion.minute);

  progressText.textContent = `Aufgabe ${questionsDone + 1} von ${TOTAL_QUESTIONS}`;
  statRemaining.textContent = String(TOTAL_QUESTIONS - questionsDone);
}

function applyRecognitionText(raw) {
  lastRaw = raw || "";
  lastSpoken = extractFirstAllowedPhrase(lastRaw);
  heardUI.textContent = lastSpoken;
}

function checkAnswer() {
  if(!lastRaw) {
    showFeedback("Bitte sprechen oder zuerst auf 'Sprechen' klicken", "error");
    return;
  }

  const hay = normalizeForCompare(lastRaw);
  const needle = normalizeForCompare(currentQuestion.expected);
  const ok = hay.includes(needle);

  if(ok) {
    correctAnswers++;
    statCorrect.textContent = String(correctAnswers);
    showFeedback("‚úì Richtig! Gut gemacht!", "ok");
  } else {
    wrongAnswers++;
    statWrong.textContent = String(wrongAnswers);
    showFeedback(`‚úó Fast! Richtige Antwort: ${currentQuestion.expected}`, "error");
  }

  questionsDone++;
  if(questionsDone >= TOTAL_QUESTIONS) {
    setTimeout(endTraining, 1500);
  } else {
    setTimeout(newQuestion, 1500);
  }
}

function showFeedback(message, type) {
  feedback.textContent = message;
  feedback.className = `feedback ${type}`;
  
  if(type === "ok") {
    feedback.innerHTML = `<span style="font-size: 1.5em;">‚úì</span> ${message}`;
  } else {
    feedback.innerHTML = `<span style="font-size: 1.5em;">‚úó</span> ${message}`;
  }
}

function endTraining() {
  quizScreen.classList.add("hidden");
  resultScreen.classList.remove("hidden");
  
  const percentage = ((correctAnswers / TOTAL_QUESTIONS) * 100).toFixed(0);
  const grade = percentage >= 90 ? "Sehr gut! üèÜ" :
                percentage >= 75 ? "Gut gemacht! üëç" :
                percentage >= 60 ? "Weiter so! üëå" :
                "Mehr √úbung hilft! üí™";
  
  resultSummary.innerHTML = `
    <strong>${grade}</strong><br><br>
    Du hast <strong>${TOTAL_QUESTIONS}</strong> Uhrzeiten gel√∂st.<br>
    Richtig: <strong style="color: #10b981;">${correctAnswers}</strong> (${percentage}%)<br>
    Falsch: <strong style="color: #ef4444;">${wrongAnswers}</strong>
  `;
}

/* ==========================
   SPEECH RECOGNITION
========================== */
let recognizer = null;
let isListening = false;

function setupSpeech() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if(!SpeechRecognition) {
    srNote.textContent = "Spracherkennung nicht verf√ºgbar. Bitte Chrome oder Edge verwenden.";
    return;
  }

  try {
    recognizer = new SpeechRecognition();
    recognizer.lang = "de-DE";
    recognizer.interimResults = false;
    recognizer.continuous = false;
    recognizer.maxAlternatives = 1;

    recognizer.onstart = () => {
      isListening = true;
      micBtn.classList.add("listening");
      micBtn.innerHTML = '<span>‚èπ</span> Aufnahme...';
      showFeedback("Sprich jetzt die Uhrzeit...", "ok");
    };

    recognizer.onend = () => {
      isListening = false;
      micBtn.classList.remove("listening");
      micBtn.innerHTML = '<span>üé§</span> Sprechen';
    };

    recognizer.onerror = (e) => {
      isListening = false;
      micBtn.classList.remove("listening");
      micBtn.innerHTML = '<span>üé§</span> Sprechen';
      
      if(e.error === "not-allowed") {
        showFeedback("Mikrofon-Zugriff wurde verweigert", "error");
      } else if(e.error === "no-speech") {
        showFeedback("Keine Sprache erkannt. Bitte lauter sprechen", "error");
      } else {
        showFeedback(`Sprach-Fehler: ${e.error}`, "error");
      }
    };

    recognizer.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      applyRecognitionText(transcript);
      showFeedback("Sprache erkannt! Klicke auf '√úberpr√ºfen'", "ok");
    };

  } catch(error) {
    console.error("Speech recognition error:", error);
    srNote.textContent = "Spracherkennung konnte nicht gestartet werden";
  }
}

micBtn.addEventListener("click", () => {
  if(!recognizer) {
    setupSpeech();
    if(!recognizer) return;
  }

  if(isListening) {
    recognizer.stop();
  } else {
    try {
      recognizer.start();
    } catch(error) {
      showFeedback("Bitte kurz warten und erneut klicken", "error");
    }
  }
});

checkBtn.addEventListener("click", checkAnswer);

// Enter-Taste f√ºr schnelle √úberpr√ºfung
document.addEventListener("keydown", (e) => {
  if(e.key === "Enter" && !quizScreen.classList.contains("hidden")) {
    checkAnswer();
  }
});

/* ==========================
   INITIALIZATION
========================== */
function init() {
  drawClock(12, 0);
  setupSpeech();
  updateStartControls();
}

// Starte die App
init();
</script>
</body>
</html>
