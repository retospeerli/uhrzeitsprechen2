<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uhrzeit â€“ Sprechen (1. Klasse)</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f3f4f6;}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:14px;}
    .app{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:1.6rem 1.4rem;max-width:660px;width:100%;box-sizing:border-box;}
    h1{margin:0 0 .4rem;text-align:center;font-size:1.6rem;}
    .subtitle{text-align:center;color:#4b5563;margin-bottom:1rem;font-size:.95rem;line-height:1.35;}
    .hidden{display:none;}
    .center{text-align:center;}
    .choice-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.6rem;margin:.7rem 0 .4rem;}
    .choice-btn{padding:.9rem .6rem;border-radius:16px;border:2px solid #d1d5db;background:#f9fafb;font-size:1rem;font-weight:650;cursor:pointer;}
    .choice-btn.selected{background:#2563eb;color:#fff;border-color:#1d4ed8;box-shadow:0 5px 15px rgba(37,99,235,.35);}
    .selected-info{font-size:.85rem;color:#6b7280;text-align:center;min-height:1.2rem;margin:.2rem 0 .3rem;}
    .primary-btn{margin-top:.8rem;width:100%;padding:.75rem 1rem;font-size:1.1rem;border:none;border-radius:999px;cursor:pointer;background:#2563eb;color:#fff;font-weight:800;}
    .primary-btn:disabled{background:#9ca3af;cursor:not-allowed;}
    .secondary-btn{margin-top:.4rem;width:100%;padding:.65rem 1rem;font-size:1rem;border-radius:999px;border:1px solid #d1d5db;cursor:pointer;background:#f9fafb;color:#111827;font-weight:700;}
    .progress{text-align:center;color:#6b7280;font-size:.9rem;margin-bottom:.4rem;}
    .tag{display:inline-block;border-radius:999px;padding:.15rem .6rem;font-size:.8rem;background:#eff6ff;color:#1d4ed8;}
    .clock-wrapper{display:flex;justify-content:center;margin-top:.6rem;}
    #clock-canvas{background:#f9fafb;border-radius:50%;box-shadow:inset 0 0 5px rgba(0,0,0,.08);}
    .answer-box{margin-top:1rem;border:1px solid #e5e7eb;background:#f9fafb;border-radius:14px;padding:.9rem;}
    .equation{text-align:center;margin:.4rem 0 .2rem;font-size:1.05rem;color:#111827;font-weight:900;}
    .mic-row{display:grid;grid-template-columns:1fr;gap:.6rem;margin-top:.6rem;}
    @media (min-width:560px){.mic-row{grid-template-columns:1fr 1fr;}}
    .mic-btn{width:100%;padding:.75rem 1rem;font-size:1.05rem;border-radius:999px;border:none;cursor:pointer;font-weight:900;background:#111827;color:#fff;}
    .mic-btn.listening{background:#dc2626;}
    .mic-btn:disabled{background:#9ca3af;cursor:not-allowed;}
    .heard{margin-top:.6rem;font-size:.98rem;color:#111827;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.7rem .8rem;min-height:2.2rem;word-break:break-word;}
    .heard strong{display:block;margin-bottom:.25rem;color:#374151;}
    .hint{font-size:.85rem;color:#6b7280;margin-top:.5rem;line-height:1.35;}
    .feedback{min-height:1.4rem;margin-top:.6rem;font-weight:900;text-align:center;}
    .feedback.ok{color:#15803d;}
    .feedback.error{color:#b91c1c;}
    .stats{margin-top:.9rem;font-size:.95rem;color:#374151;}
    .input-fallback{width:100%;padding:.7rem .8rem;border-radius:12px;border:2px solid #d1d5db;background:#fff;font-size:1.02rem;font-weight:650;color:#111827;outline:none;box-sizing:border-box;}
  </style>
</head>
<body>
<div class="app">
  <h1>Wie spÃ¤t ist es?</h1>
  <div class="subtitle">
    Lies die analoge Uhr und sage die <strong>Uhrzeit in Alltagssprache</strong>.<br>
    <strong>Einfach:</strong> nur <strong>volle</strong> & <strong>halbe</strong> Stunden.<br>
    <strong>Schwierig:</strong> zusÃ¤tzlich <strong>Viertel nach</strong> & <strong>Viertel vor</strong>.
  </div>

  <!-- START -->
  <div id="start-screen">
    <div class="center"><p>Bitte Schwierigkeit wÃ¤hlen.</p></div>

    <div class="center" style="margin-top:1rem;">Schwierigkeit</div>
    <div class="choice-grid" id="difficulty-grid">
      <button type="button" class="choice-btn difficulty-btn" data-diff="easy">einfach</button>
      <button type="button" class="choice-btn difficulty-btn" data-diff="hard">schwierig</button>
    </div>

    <div class="selected-info" id="selected-info"></div>
    <button class="primary-btn" id="start-btn" disabled>Los!</button>
    <div class="hint center" id="sr-note"></div>
  </div>

  <!-- QUIZ -->
  <div id="quiz-screen" class="hidden">
    <div class="progress" id="progress-text"></div>
    <div class="center">
      <span class="tag" id="variant-label"></span>
      <div class="equation">Klicke auf Sprechen und sage die passende Uhrzeit:</div>
      <div class="hint">Anzeige zeigt <strong>deinen Text</strong>. Wenn er stimmt: <strong>ÃœberprÃ¼fen</strong>.</div>
    </div>

    <div class="clock-wrapper">
      <canvas id="clock-canvas" width="240" height="240"></canvas>
    </div>

    <div class="answer-box">
      <div class="mic-row">
        <button class="mic-btn" id="mic-btn">ðŸŽ¤ Sprechen</button>
        <button class="secondary-btn" id="check-btn" style="margin-top:0;">ÃœberprÃ¼fen</button>
      </div>

      <div id="fallback-wrap" class="hidden" style="margin-top:.6rem;">
        <input id="fallback-input" class="input-fallback" placeholder="Falls Sprechen nicht geht: Text eintippenâ€¦" />
        <div class="hint">Chrome/Edge empfohlen.</div>
      </div>

      <div class="heard" id="heard-raw"><strong>Rohtext (1:1):</strong> â€”</div>
      <div class="heard" id="heard-col"><strong>Text in Alltagssprache:</strong> â€”</div>

      <div class="feedback" id="feedback"></div>
    </div>

    <div class="stats">
      Richtig: <span id="stat-correct">0</span> / <span id="stat-total">20</span><br>
      Falsche Versuche: <span id="stat-wrong">0</span><br>
      Modus: <span id="stat-mode"></span>
    </div>
  </div>

  <!-- RESULT -->
  <div id="result-screen" class="hidden center">
    <h2>Fertig! ðŸŽ‰</h2>
    <p id="result-summary"></p>
    <p style="margin-top:.8rem; font-size:.9rem; color:#4b5563;">
      Klicke auf <strong>â€žFertigâ€œ</strong>, damit LearningView den Auftrag als erledigt markiert.
    </p>
    <button class="primary-btn" id="finish-btn">Fertig</button>
    <button class="secondary-btn" id="restart-btn">Weiter Ã¼ben</button>
  </div>
</div>

<script>
/* ==========================
   SETTINGS / STATE
========================== */
const TOTAL_QUESTIONS = 20;
const DIFF_LABELS  = {easy:"einfach",hard:"schwierig"};

const HOURS_WORDS = ["eins","zwei","drei","vier","fÃ¼nf","sechs","sieben","acht","neun","zehn","elf","zwÃ¶lf"];
const numToWord = (n)=>HOURS_WORDS[(n-1+12)%12];

const correctSound = new Audio("audio/correct.wav");
const errorSound   = new Audio("audio/error.wav");

/* Minuten-Muster pro Schwierigkeitsgrad (1. Klasse) */
const PATTERNS_EASY = [
  { minute: 0,  label: "punkt" },
  { minute: 30, label: "halb" },
];
const PATTERNS_HARD = [
  { minute: 0,  label: "punkt" },
  { minute: 15, label: "viertel nach" },
  { minute: 30, label: "halb" },
  { minute: 45, label: "viertel vor" },
];

let selectedDifficulty=null;
let questionsDone=0, correctAnswers=0, wrongAnswers=0;
let usedKeys = new Set();
let currentQuestion=null;

let lastRaw = "";
let lastCol = "";
let speechBuffer = "";
let silenceTimer = null;
let lastFinalChunk = "";

/* ==========================
   DOM
========================== */
const startScreen = document.getElementById("start-screen");
const quizScreen = document.getElementById("quiz-screen");
const resultScreen = document.getElementById("result-screen");

const difficultyGrid = document.getElementById("difficulty-grid");
const selectedInfo = document.getElementById("selected-info");
const startBtn = document.getElementById("start-btn");
const srNote = document.getElementById("sr-note");

const progressText = document.getElementById("progress-text");
const variantLabel = document.getElementById("variant-label");

const heardRawEl = document.getElementById("heard-raw");
const heardColEl = document.getElementById("heard-col");
const feedback = document.getElementById("feedback");

const statCorrect = document.getElementById("stat-correct");
const statTotal = document.getElementById("stat-total");
const statWrong = document.getElementById("stat-wrong");
const statMode = document.getElementById("stat-mode");

const restartBtn = document.getElementById("restart-btn");
const finishBtn = document.getElementById("finish-btn");
const resultSummary = document.getElementById("result-summary");

const micBtn = document.getElementById("mic-btn");
const checkBtn = document.getElementById("check-btn");
const fallbackWrap = document.getElementById("fallback-wrap");
const fallbackInput = document.getElementById("fallback-input");

const clockCanvas = document.getElementById("clock-canvas");
const clockCtx = clockCanvas.getContext("2d");

/* ==========================
   HELPERS
========================== */
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp12(h){ return ((h-1)%12)+1; }
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function normalizeForCompare(s){
  return String(s)
    .toLowerCase()
    .replace(/[^\p{L}\p{N}\s]/gu, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function getActivePatterns(){
  return (selectedDifficulty==="hard") ? PATTERNS_HARD : PATTERNS_EASY;
}

function timeToColloquial(hour, minute){
  const h = clamp12(hour);
  const next = (h%12)+1;
  const hw = numToWord(h);
  const nhw = numToWord(next);

  switch(minute){
    case 0:  return `punkt ${hw}`;
    case 30: return `halb ${nhw}`;
    case 15: return `viertel nach ${hw}`;
    case 45: return `viertel vor ${nhw}`;
    default: return hw;
  }
}

function playSound(a){
  try{
    a.pause();
    a.currentTime = 0;
    const p = a.play();
    if(p && typeof p.catch === "function") p.catch(()=>{});
  }catch(_){}
}

/* ==========================
   ROH -> ALLTAGSTEXT
   (Zahlzeiten werden auf punkt/halb/viertel nach/viertel vor umgeschrieben)
========================== */
function normalizeToColloquialText(raw){
  if(!raw) return "";
  let t = raw.replace(/\s+/g," ").trim();

  // Reine Zahlzeit: "9:15" / "09.45"
  t = t.replace(/\b(\d{1,2})[:.](\d{2})\b/g, (m, hh, mm) => {
    let H = parseInt(hh,10);
    let M = parseInt(mm,10);
    if(!Number.isFinite(H) || !Number.isFinite(M)) return m;
    if(H===0) H=12;
    H = ((H-1)%12)+1;

    // nur Minuten erlauben, die im Modus vorkommen (easy: 0/30, hard: 0/15/30/45)
    const allowed = new Set(getActivePatterns().map(p=>p.minute));
    if(!allowed.has(M)) return m;

    return timeToColloquial(H, M);
  });

  // Ziffern 0..12 als Tokens -> Wort (Anzeige angenehmer)
  const map = {
    "0":"zwÃ¶lf","1":"eins","2":"zwei","3":"drei","4":"vier","5":"fÃ¼nf","6":"sechs",
    "7":"sieben","8":"acht","9":"neun","10":"zehn","11":"elf","12":"zwÃ¶lf",
    "15":"fÃ¼nfzehn","30":"dreissig","45":"fÃ¼nfundvierzig"
  };
  t = t.replace(/\b(45|30|15|1[0-2]|[0-9])\b/g, m => map[m] ?? m);

  return t.toLowerCase().replace(/\s+/g," ").trim();
}

function bufferHasHour(text){
  const t = normalizeForCompare(text);
  if (/\b(eins|zwei|drei|vier|fÃ¼nf|sechs|sieben|acht|neun|zehn|elf|zwÃ¶lf)\b/.test(t)) return true;
  if (/\b(1[0-2]|[1-9])\b/.test(t)) return true;
  return false;
}

/* ==========================
   QUIZ GENERATION (20)
========================== */
let lastMinute = null;

function generateQuestion(index){
  const patterns = getActivePatterns();
  let minute = patterns[index % patterns.length].minute;

  // nicht zweimal dieselbe Minute hintereinander, wenn mÃ¶glich
  if(lastMinute !== null && minute === lastMinute && patterns.length > 1){
    minute = patterns[(index+1) % patterns.length].minute;
  }
  lastMinute = minute;

  let hour, tries=0;
  while(true){
    hour = randomInt(1,12);
    const key = `${hour}:${minute}:${selectedDifficulty}`; // Modus mit reinnehmen
    if(!usedKeys.has(key)){
      usedKeys.add(key);
      break;
    }
    if(++tries>200) break;
  }

  const expected = timeToColloquial(hour, minute);
  const label = patterns.find(p=>p.minute===minute)?.label ?? "";
  return {hour, minute, expected, label};
}

/* ==========================
   CLOCK
========================== */
function drawClock(hour, minute){
  const ctx=clockCtx;
  const w=clockCanvas.width, h=clockCanvas.height;
  const r=Math.min(w,h)/2-12;
  const cx=w/2, cy=h/2;

  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.translate(cx,cy);

  ctx.beginPath();
  ctx.arc(0,0,r,0,Math.PI*2);
  ctx.fillStyle="#ffffff";
  ctx.fill();
  ctx.lineWidth=3;
  ctx.strokeStyle="#111827";
  ctx.stroke();

  for(let i=0;i<60;i++){
    const a=(Math.PI/30)*i - Math.PI/2;
    const isHour=(i%5===0);
    const outer=r-6;
    const inner=r-(isHour?20:12);
    ctx.beginPath();
    ctx.moveTo(inner*Math.cos(a), inner*Math.sin(a));
    ctx.lineTo(outer*Math.cos(a), outer*Math.sin(a));
    ctx.lineWidth=isHour?3:1.2;
    ctx.strokeStyle="#111827";
    ctx.stroke();
  }

  // Minutenzeiger blau (dicker)
  const ma=(Math.PI/30)*minute - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo((r-24)*Math.cos(ma), (r-24)*Math.sin(ma));
  ctx.lineWidth=4;
  ctx.strokeStyle="#2563eb";
  ctx.lineCap="round";
  ctx.stroke();

  // Stundenzeiger rot (dicker)
  const ha=(Math.PI/6)*((hour%12)+minute/60) - Math.PI/2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo((r-62)*Math.cos(ha), (r-62)*Math.sin(ha));
  ctx.lineWidth=5;
  ctx.strokeStyle="#dc2626";
  ctx.lineCap="round";
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(0,0,5,0,Math.PI*2);
  ctx.fillStyle="#111827";
  ctx.fill();

  ctx.restore();
}

/* ==========================
   UI
========================== */
function updateStartControls(){
  if(!selectedDifficulty){
    selectedInfo.textContent="Bitte eine Schwierigkeit auswÃ¤hlen.";
    startBtn.disabled=true;
    return;
  }
  selectedInfo.textContent = `AusgewÃ¤hlt: 1. Klasse, ${DIFF_LABELS[selectedDifficulty]}`;
  startBtn.disabled=false;
}

difficultyGrid.querySelectorAll(".difficulty-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const d = btn.dataset.diff;
    selectedDifficulty = (selectedDifficulty===d) ? null : d;
    difficultyGrid.querySelectorAll(".difficulty-btn").forEach(b=>b.classList.toggle("selected", b.dataset.diff===selectedDifficulty));
    updateStartControls();
  });
});

startBtn.addEventListener("click", startTraining);
restartBtn.addEventListener("click", ()=>{
  quizScreen.classList.add("hidden");
  resultScreen.classList.add("hidden");
  startScreen.classList.remove("hidden");
});

finishBtn.addEventListener("click", ()=>{
  finishBtn.disabled=true;
  finishBtn.textContent="Erledigt âœ”";
  try{
    if(window.parent && window.parent !== window){
      window.parent.postMessage("AppSolved","*");
    }
  }catch(_){}
});

/* ==========================
   QUIZ FLOW
========================== */
function startTraining(){
  questionsDone=0; correctAnswers=0; wrongAnswers=0;
  usedKeys = new Set();
  lastMinute = null;

  statCorrect.textContent="0";
  statWrong.textContent="0";
  statTotal.textContent=String(TOTAL_QUESTIONS);
  statMode.textContent=`1. Klasse â€“ ${DIFF_LABELS[selectedDifficulty]}`;

  lastRaw = "";
  lastCol = "";

  feedback.textContent="";
  feedback.className="feedback";
  heardRawEl.innerHTML="<strong>Rohtext (1:1):</strong> â€”";
  heardColEl.innerHTML="<strong>Text in Alltagssprache:</strong> â€”";
  fallbackInput.value="";

  startScreen.classList.add("hidden");
  resultScreen.classList.add("hidden");
  quizScreen.classList.remove("hidden");

  // Grammatik nach Modus neu setzen (wichtig!)
  setupSpeech();

  newQuestion();
}

function newQuestion(){
  feedback.textContent="";
  feedback.className="feedback";
  lastRaw="";
  lastCol="";
  heardRawEl.innerHTML="<strong>Rohtext (1:1):</strong> â€”";
  heardColEl.innerHTML="<strong>Text in Alltagssprache:</strong> â€”";
  fallbackInput.value="";

  currentQuestion = generateQuestion(questionsDone);

  variantLabel.textContent = (selectedDifficulty==="hard")
    ? "Erlaubt: punkt / halb / viertel nach / viertel vor"
    : "Erlaubt: punkt / halb";

  drawClock(currentQuestion.hour, currentQuestion.minute);
  progressText.textContent = `Aufgabe ${questionsDone+1} von ${TOTAL_QUESTIONS}`;
}

function checkAnswer(){
  if(!lastRaw && fallbackInput.value.trim()){
    lastRaw = fallbackInput.value.trim();
    lastCol = normalizeToColloquialText(lastRaw);
    heardRawEl.innerHTML = "<strong>Rohtext (1:1):</strong> " + escapeHtml(lastRaw);
    heardColEl.innerHTML = "<strong>Text in Alltagssprache:</strong> " + escapeHtml(lastCol);
  }

  if(!lastCol){
    feedback.textContent="Ich habe noch keinen Text (Sprechen oder eintippen).";
    feedback.className="feedback error";
    return;
  }

  const hay = normalizeForCompare(lastCol);
  const needle = normalizeForCompare(currentQuestion.expected);
  const ok = hay.includes(needle);

  if(ok){
    playSound(correctSound);
    correctAnswers++;
    statCorrect.textContent=String(correctAnswers);
    feedback.textContent="Richtig! ðŸ‘";
    feedback.className="feedback ok";
  }else{
    playSound(errorSound);
    wrongAnswers++;
    statWrong.textContent=String(wrongAnswers);
    feedback.textContent="Falsch. Gesucht war: " + currentQuestion.expected;
    feedback.className="feedback error";
  }

  questionsDone++;
  if(questionsDone>=TOTAL_QUESTIONS) setTimeout(endTraining, 700);
  else setTimeout(newQuestion, 700);
}

function endTraining(){
  quizScreen.classList.add("hidden");
  resultScreen.classList.remove("hidden");
  const quote = (correctAnswers/TOTAL_QUESTIONS*100).toFixed(0);
  resultSummary.innerHTML =
    `Du hast <strong>${TOTAL_QUESTIONS}</strong> Uhrzeiten gelÃ¶st.<br>`+
    `Richtig: <strong>${correctAnswers}</strong> (${quote}%).<br>`+
    `Falsch: <strong>${wrongAnswers}</strong>.`;
}

/* ==========================
   SPEECH
========================== */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognizer=null, isListening=false;

function setupSpeech(){
  // falls schon aktiv: sauber stoppen und neu erzeugen
  try{ if(recognizer && isListening) recognizer.stop(); }catch(_){}
  recognizer = null;
  isListening = false;

  if(!SR){
    micBtn.disabled=true;
    micBtn.textContent="ðŸŽ¤ Nicht verfÃ¼gbar";
    fallbackWrap.classList.remove("hidden");
    srNote.textContent="Spracherkennung lÃ¤uft am zuverlÃ¤ssigsten in Chrome/Edge.";
    return;
  }

  recognizer = new SR();

  // Grammatik passend zum Modus (nur erlaubte Phrasen)
  const SGL = window.SpeechGrammarList || window.webkitSpeechGrammarList;
  if (SGL){
    const hours = ["eins","zwei","drei","vier","fÃ¼nf","sechs","sieben","acht","neun","zehn","elf","zwÃ¶lf"];
    const prefixesEasy = ["punkt","halb"];
    const prefixesHard = ["punkt","halb","viertel nach","viertel vor"];
    const prefixes = (selectedDifficulty==="hard") ? prefixesHard : prefixesEasy;

    const phrases = [];
    for (const p of prefixes) for (const h of hours) phrases.push(`${p} ${h}`);

    const grammar =
      "#JSGF V1.0; grammar time; public <time> = " +
      phrases.join(" | ") + " ;";

    const gl = new SGL();
    gl.addFromString(grammar, 1);
    recognizer.grammars = gl;
  }

  recognizer.lang = "de-CH";
  recognizer.interimResults = true;
  recognizer.continuous = true;
  recognizer.maxAlternatives = 8;

  recognizer.onstart = () => {
    isListening=true;
    micBtn.classList.add("listening");
    micBtn.textContent="â¹ Stop";
    feedback.textContent="";
    feedback.className="feedback";
  };

  recognizer.onend = () => {
    isListening=false;
    micBtn.classList.remove("listening");
    micBtn.textContent="ðŸŽ¤ Sprechen";
    clearTimeout(silenceTimer);
    silenceTimer = null;
  };

  recognizer.onerror = (e) => {
    feedback.textContent="Sprach-Fehler: " + (e.error || "unbekannt");
    feedback.className="feedback error";
    fallbackWrap.classList.remove("hidden");
  };

  recognizer.onresult = (e) => {
    const res = e.results;
    let chunk = "";
    for (let i = e.resultIndex; i < res.length; i++) {
      if (!res[i].isFinal) continue;

      const best = (res[i]?.[0]?.transcript || "").trim();
      if (!best) continue;

      if (best === lastFinalChunk) continue;
      lastFinalChunk = best;

      chunk += (chunk ? " " : "") + best;
    }

    if (chunk) speechBuffer = (speechBuffer ? speechBuffer + " " : "") + chunk;
    speechBuffer = speechBuffer.replace(/\s+/g, " ").trim();

    lastRaw = speechBuffer;
    lastCol = normalizeToColloquialText(lastRaw);

    heardRawEl.innerHTML = "<strong>Rohtext (1:1):</strong> " + escapeHtml(lastRaw || "â€”");
    heardColEl.innerHTML = "<strong>Text in Alltagssprache:</strong> " + escapeHtml(lastCol || "â€”");

    clearTimeout(silenceTimer);

    if (!bufferHasHour(lastRaw)) {
      feedback.textContent = "Stunde fehlt â€“ bitte z.B. â€žâ€¦ siebenâ€œ ergÃ¤nzen.";
      feedback.className = "feedback error";
      silenceTimer = setTimeout(() => { try { recognizer.stop(); } catch(_) {} }, 2500);
      return;
    }

    feedback.textContent = "OK â€“ erkannt. (Jetzt â€žÃœberprÃ¼fenâ€œ.)";
    feedback.className = "feedback ok";

    silenceTimer = setTimeout(() => { try { recognizer.stop(); } catch(_) {} }, 900);
  };

  srNote.textContent="Mikrofon erlauben, dann â€žSprechenâ€œ klicken. (Chrome/Edge empfohlen)";
}

micBtn.addEventListener("click", ()=>{
  if(!recognizer){ fallbackWrap.classList.remove("hidden"); return; }
  if(isListening){ try{ recognizer.stop(); }catch(_){ } return; }
  try{
    speechBuffer = "";
    lastFinalChunk = "";
    lastRaw = "";
    lastCol = "";
    clearTimeout(silenceTimer);
    silenceTimer = null;
    recognizer.start();
  }catch(_){
    feedback.textContent="Bitte kurz warten und nochmals klicken.";
    feedback.className="feedback error";
  }
});

checkBtn.addEventListener("click", checkAnswer);
fallbackInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ e.preventDefault(); checkAnswer(); }
});

/* ==========================
   INIT
========================== */
(function init(){
  statTotal.textContent=String(TOTAL_QUESTIONS);
  drawClock(12,0);
  updateStartControls();
  setupSpeech();
})();
</script>
</body>
</html>
